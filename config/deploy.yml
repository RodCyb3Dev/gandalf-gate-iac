# Kamal deployment configuration for secure homelab
# Zero-downtime deployments using Docker images
# Documentation: https://kamal-deploy.org/docs/configuration/overview/

# =============================================================================
# ANCHORS (Reusable configuration)
# =============================================================================
# Documentation: https://kamal-deploy.org/docs/configuration/anchors/
x-common-env: &common-env
  TZ: Europe/Helsinki
  DOMAIN: rodneyops.com
  PUID: "1000"
  PGID: "1000"
  SMTP_HOST: smtp.protonmail.ch
  SMTP_PORT: "587"
  VPN_PROVIDER: protonvpn
  VPN_ADDRESSES: 10.2.0.2/32
  VPN_COUNTRIES: Netherlands
  TAILSCALE_DOMAIN: kooka-lake.ts.net
  JELLYFIN_PUBLISHED_URL: https://jellyfin.kooka-lake.ts.net
  GRAFANA_ADMIN_USER: admin
  GOTIFY_ADMIN_USER: admin
  KAMAL_REGISTRY: ghcr.io

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================
service: homelab
# Container image (GitHub Container Registry)
# Note: Kamal prepends the registry server, so don't include ghcr.io/ here
image: rodcyb3dev/homelab

# =============================================================================
# SERVERS
# =============================================================================
# Documentation: https://kamal-deploy.org/docs/configuration/servers/
# Servers should only have IP addresses or hostnames
# Disable Kamal proxy since we're using Traefik
servers:
  web:
    hosts:
      - 95.216.176.147
    proxy: false

# =============================================================================
# PROXY CONFIGURATION
# =============================================================================
# Documentation: https://kamal-deploy.org/docs/configuration/proxy/
# Kamal proxy provides gapless deployments on ports 80 and 443
# Since we're using Traefik, we disable Kamal's proxy
proxy:
  ssl: true
  host: rodneyops.com
  app_port: 80
  # Disable Kamal proxy since we're using Traefik
  # The proxy will be disabled on the server role below

# =============================================================================
# DOCKER REGISTRY CONFIGURATION
# =============================================================================
# Documentation: https://kamal-deploy.org/docs/configuration/docker-registry/
registry:
  server: ghcr.io
  username: RodCyb3Dev
  password:
    - KAMAL_REGISTRY_PASSWORD

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
env:
  clear:
    <<: *common-env
  secret:
    - STORAGE_BOX_PASSWORD
    - CF_API_TOKEN
    - TAILSCALE_AUTH_KEY
    - CROWDSEC_ENROLL_KEY
    - CROWDSEC_BOUNCER_API_KEY
    - AUTHELIA_JWT_SECRET
    - AUTHELIA_SESSION_SECRET
    - AUTHELIA_STORAGE_ENCRYPTION_KEY
    - SMTP_USERNAME
    - SMTP_PASSWORD
    - GRAFANA_ADMIN_PASSWORD
    - GOTIFY_ADMIN_PASSWORD
    - VPN_PRIVATE_KEY

# =============================================================================
# SSH CONFIGURATION
# =============================================================================
ssh:
  user: deploy
  port: 22

# =============================================================================
# BUILDER CONFIGURATION
# =============================================================================
builder:
  arch: amd64

# =============================================================================
# ACCESSORIES (Supporting services)
# =============================================================================
# Documentation: https://kamal-deploy.org/docs/configuration/accessories/
accessories:
  db:
    image: postgres:15-alpine
    host: 95.216.176.147
    port: 5432
    env:
      clear:
        POSTGRES_DB: homelab
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  - config:/opt/homelab/config
  - prometheus-data:/opt/homelab/prometheus-data
  - grafana-data:/opt/homelab/grafana-data
  - loki-data:/opt/homelab/loki-data
