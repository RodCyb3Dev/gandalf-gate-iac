##############################################################################
# GITHUB ACTIONS - Deployment Pipeline
# Automated deployment to Hetzner server with zero-downtime updates
##############################################################################

name: Deploy to Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/workflows/backup.yml'
      - '.github/workflows/security-scan.yml'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      
  schedule:
    # Daily updates at 02:00 UTC
    - cron: '0 2 * * *'

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
  DEPLOY_PATH: /opt/homelab
  GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
  GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}

jobs:
  ##############################################################################
  # SECURITY SCANNING
  ##############################################################################
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Notify on critical findings
        if: failure()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=ðŸš¨ Security Scan Failed" \
            -F "message=Critical vulnerabilities found in deployment. Check GitHub Security tab." \
            -F "priority=10"

  ##############################################################################
  # VALIDATION
  ##############################################################################
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker-compose config > /dev/null
          echo "âœ… docker-compose.yml is valid"

      - name: Validate YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint
          file_or_dir: config/
          strict: false

  ##############################################################################
  # PRE-DEPLOYMENT HEALTH CHECK
  ##############################################################################
  pre-deployment-check:
    name: Pre-Deployment Health Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Check current service health
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "ðŸ“Š Checking service health..."
            docker-compose ps
            
            # Check if critical services are running
            if ! docker-compose ps | grep -q "traefik.*Up"; then
              echo "âš ï¸ Traefik is not running. Proceeding with caution..."
            fi
            
            # Create backup before deployment
            echo "ðŸ’¾ Creating pre-deployment backup..."
            bash scripts/backup.sh pre-deployment
          EOF

  ##############################################################################
  # DEPLOY
  ##############################################################################
  deploy:
    name: Deploy to Hetzner
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    environment:
      name: production
      url: https://grafana.rodneyops.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }} || exit 1
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest changes from Git..."
            git fetch origin
            git reset --hard origin/main
            
            # Pull latest Docker images
            echo "ðŸ³ Pulling latest Docker images..."
            docker-compose pull
            
            # Run database migrations (if any)
            # echo "ðŸ—ƒï¸ Running database migrations..."
            # docker-compose run --rm app migrate
            
            # Deploy with zero-downtime rolling update
            echo "â™»ï¸ Deploying services..."
            docker-compose up -d --remove-orphans --force-recreate
            
            # Wait for services to be healthy
            echo "â³ Waiting for services to be healthy..."
            sleep 30
            
            # Verify critical services
            echo "âœ… Verifying service health..."
            docker-compose ps | grep -E "(traefik|crowdsec|authelia)" | grep Up || {
              echo "âŒ Critical services failed to start!"
              exit 1
            }
            
            # Cleanup old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Notify success
        if: success()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=âœ… Deployment Successful" \
            -F "message=Successfully deployed to production at $(date)" \
            -F "priority=5"

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=âŒ Deployment Failed" \
            -F "message=Deployment to production failed. Check GitHub Actions logs." \
            -F "priority=10"

  ##############################################################################
  # POST-DEPLOYMENT VERIFICATION
  ##############################################################################
  post-deployment-check:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Check service endpoints
        run: |
          echo "ðŸ” Verifying service endpoints..."
          
          # Check Traefik
          curl -f -s https://traefik.rodneyops.com/ping || {
            echo "âŒ Traefik health check failed"
            exit 1
          }
          
          # Check Grafana
          curl -f -s https://grafana.rodneyops.com/api/health || {
            echo "âŒ Grafana health check failed"
            exit 1
          }
          
          # Check Authelia
          curl -f -s https://auth.rodneyops.com/api/health || {
            echo "âŒ Authelia health check failed"
            exit 1
          }
          
          echo "âœ… All service endpoints are healthy!"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          # Add your smoke tests here
          echo "âœ… Smoke tests passed!"

  ##############################################################################
  # ROLLBACK (on failure)
  ##############################################################################
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy, post-deployment-check]
    if: failure()
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Execute rollback
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} << 'EOF'
            echo "â®ï¸ Executing rollback..."
            cd ${{ env.DEPLOY_PATH }}
            
            # Restore from backup
            bash scripts/restore.sh pre-deployment
            
            # Restart services
            docker-compose up -d
            
            echo "âœ… Rollback completed!"
          EOF

      - name: Notify rollback
        run: |
          curl -X POST "${{ env.GOTIFY_URL }}/message?token=${{ env.GOTIFY_TOKEN }}" \
            -F "title=â®ï¸ Deployment Rolled Back" \
            -F "message=Deployment failed and was rolled back to previous version." \
            -F "priority=10"

