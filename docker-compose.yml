##############################################################################
# CORE INFRASTRUCTURE - Secure Homelab Base
# Security Stack
##############################################################################
networks:
  pangolin-proxy:
    driver: bridge
    name: pangolin-proxy

secrets:
  cf-token:
    file: ./config/traefik/cf-token
  JWT_SECRET:
    file: ./config/authelia/secrets/JWT_SECRET
  SESSION_SECRET:
    file: ./config/authelia/secrets/SESSION_SECRET
  STORAGE_PASSWORD:
    file: ./config/authelia/secrets/STORAGE_PASSWORD
  STORAGE_ENCRYPTION_KEY:
    file: ./config/authelia/secrets/STORAGE_ENCRYPTION_KEY

services:
  ##############################################################################
  # SECURITY LAYER - Crowdsec
  ##############################################################################

  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: crowdsec
    command: -t
    ports:
      - 6060:6060
    expose:
      - 6060
    environment:
      ACQUIRE_FILES: /var/log/traefik/*.log
      COLLECTIONS: crowdsecurity/traefik crowdsecurity/appsec-virtual-patching crowdsecurity/appsec-generic-rules
      ENROLL_INSTANCE_NAME: pangolin-crowdsec
      ENROLL_TAGS: docker
      GID: "1000"
      PARSERS: crowdsecurity/whitelists
    volumes:
      - ./config/pangolin/crowdsec:/etc/crowdsec
      - ./config/pangolin/crowdsec/db:/var/lib/crowdsec/data
      - ./config/pangolin/crowdsec_logs/auth.log:/var/log/auth.log:ro
      - ./config/pangolin/crowdsec_logs/syslog:/var/log/syslog:ro
      - ./config/pangolin/crowdsec_logs:/var/log
      - ./config/traefik/logs:/var/log/traefik
    healthcheck:
      test:
        - CMD
        - cscli
        - capi
        - status
    labels:
      - traefik.enable=false
    restart: unless-stopped

  ##############################################################################
  # NETWORK GATEGER - Gerbil
  ##############################################################################

  gerbil:
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    command:
      - --reachableAt=${GERBIL_REACHABLE_URL}
      - --generateAndSaveKeyTo=${GERBIL_KEY_PATH}
      - --remoteConfig=${GERBIL_CONFIG_URL}
      - --reportBandwidthTo=${GERBIL_BANDWIDTH_URL}
    container_name: gerbil
    depends_on:
      pangolin:
        condition: service_healthy
    env_file:
      - .env
    image: fosrl/gerbil:1.0.0
    ports:
      - 51820:51820/udp
      - 443:443
      - 80:80
    restart: unless-stopped
    volumes:
      - ./config/pangolin/:/var/config

  ##############################################################################
  # PANGOIN - Pangolin
  ##############################################################################

  pangolin:
    image: fosrl/pangolin:1.2.0
    container_name: pangolin
    env_file:
      - .env
    environment:
      - TZ=UTC
      - USERS_SERVERADMIN_EMAIL=${ADMIN_EMAIL}
      - USERS_SERVERADMIN_PASSWORD=${ADMIN_PASSWORD}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USERNAME}
      - SMTP_PASS=${SMTP_PASSWORD}
      - DOMAIN=${DOMAIN}
      - CF_EMAIL_SSL=${CF_EMAIL_SSL}
      - LE_EMAIL_SSL=${LE_EMAIL_SSL}
    volumes:
      - ./config/pangolin:/app/config
      - ./config/pangolin/logs:/app/logs
    healthcheck:
      interval: 30s
      retries: 5
      start_period: 60s
      test:
        - CMD
        - curl
        - -f
        - http://localhost:3001/api/v1/
      timeout: 10s
    restart: unless-stopped

  ##############################################################################
  # TRAEFIK - Traefik
  ##############################################################################

  traefik:
    command:
      - --configFile=/etc/traefik/traefik_config.yml
    container_name: traefik
    depends_on:
      pangolin:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - TRAEFIK_DASHBOARD_CREDENTIALS=${BASIC_AUTH}
      - CF_DNS_API_TOKEN_FILE=/run/secrets/cf-token
    image: traefik:v3.3.6
    network_mode: service:gerbil
    restart: unless-stopped
    secrets:
      - cf-token
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./config/traefik:/etc/traefik:ro
      - ./config/traefik/letsencrypt:/letsencrypt:rw
      - ./config/traefik/cloudflare/acme.json:/cloudflare/acme.json
      - ./config/traefik/logs:/var/log/traefik
      - /etc/localtime:/etc/localtime:ro

  ##############################################################################
  # SECURITY LAYER - Fail2ban
  ##############################################################################

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: unless-stopped
    network_mode: service:gerbil
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      - TZ=${TZ:-UTC}
      - F2B_DB_PURGE_AGE=30d
      - F2B_LOG_LEVEL=INFO
    volumes:
      - ./config/fail2ban:/data
      - /var/log:/var/log:ro
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  ##############################################################################
  # SECURITY LAYER - Authelia
  ##############################################################################

  authelia:
    image: 'docker.io/authelia/authelia:latest'
    container_name: authelia
    volumes:
      - ./config/authelia:/config
    networks:
      - pangolin-proxy
    secrets:
      - JWT_SECRET
      - SESSION_SECRET
      - STORAGE_PASSWORD
      - STORAGE_ENCRYPTION_KEY
    environment:
      TZ: Europe/Helsinki
      AUTHELIA_LOG_LEVEL: 'trace'
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE: '/run/secrets/JWT_SECRET'
      AUTHELIA_SESSION_SECRET_FILE: '/run/secrets/SESSION_SECRET'
      AUTHELIA_STORAGE_POSTGRES_PASSWORD_FILE: '/run/secrets/STORAGE_PASSWORD'
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: '/run/secrets/STORAGE_ENCRYPTION_KEY'
    security_opt:
      - no-new-privileges:true
    ports:
      - 9091:9091
    restart: unless-stopped
    healthcheck:
      disable: true
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.authelia.rule=Host(`auth.rodneyops.com`)'
      - 'traefik.http.routers.authelia.entrypoints=https'
      - 'traefik.http.routers.authelia.tls=true'
      - 'traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/authz/forward-auth'
      - 'traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true'
      - 'traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email'
      - 'traefik.http.middlewares.authelia-basic.forwardAuth.address=http://authelia:9091/api/verify?auth=basic'
      - 'traefik.http.middlewares.authelia-basic.forwardAuth.trustForwardHeader=true'
      - 'traefik.http.middlewares.authelia-basic.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email'
      - 'traefik.http.services.authelia.loadbalancer.server.port=9091'

  ##############################################################################
  # SECURITY LAYER - Redis
  ##############################################################################

  redis:
    image: redis:alpine
    container_name: redis
    volumes:
      - ./config/redis:/data
    networks:
      - pangolin-proxy
    expose:
      - 6379
    restart: unless-stopped
    environment:
      - TZ=Europe/Helsinki
