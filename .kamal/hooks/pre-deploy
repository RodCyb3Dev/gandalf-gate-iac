#!/bin/bash
# Kamal pre-deployment hook
# Syncs docker-compose.yml and config files, then runs docker-compose on host

set -e

SERVER="deploy@95.216.176.147"
HOMELAB_DIR="/opt/homelab"

echo "ðŸ” Running pre-deployment checks..."

# Ensure homelab directory exists on server
echo "ðŸ“ Ensuring homelab directory exists..."
ssh "$SERVER" "mkdir -p $HOMELAB_DIR/config"

# Sync docker-compose.yml
echo "ðŸ“¦ Syncing docker-compose.yml..."
rsync -avz docker-compose.yml "$SERVER:$HOMELAB_DIR/" || {
    echo "âŒ Failed to sync docker-compose.yml"
    exit 1
}

# Sync all config directories (excluding secrets, logs, data, runtime files)
# Note: config/traefik/* already exists on server - preserve acme.json, logs, and secrets
echo "ðŸ“‹ Syncing configuration files..."
rsync -avz \
  --exclude='*.log' \
  --exclude='*.gz' \
  --exclude='acme.json' \
  --exclude='*.db' \
  --exclude='*.sqlite*' \
  --exclude='*.state' \
  --exclude='data/' \
  --exclude='db/' \
  --exclude='cache/' \
  --exclude='logs/' \
  --exclude='*.txt' \
  --exclude='*.key' \
  --exclude='*.pem' \
  --exclude='*.crt' \
  --update \
  config/ "$SERVER:$HOMELAB_DIR/config/" || {
    echo "âš ï¸  Some config files may not have synced (check secrets manually)"
}

# Note: Secret files need to be synced separately or managed via 1Password
# They are excluded from rsync for security
echo "âš ï¸  Note: Secret files (*.txt, *.key, etc.) must be synced separately or managed via secrets"

# Create .env file on server from .kamal/secrets for docker-compose
echo "ðŸ” Creating .env file on server for docker-compose..."
if [ -f .kamal/secrets ]; then
    # Extract and map environment variables for docker-compose
    # Map TS_AUTHKEY -> TAILSCALE_AUTH_KEY and CROWDSEC_BOUNCER_KEY -> CROWDSEC_BOUNCER_KEY
    {
        grep -E '^STORAGE_BOX_PASSWORD=' .kamal/secrets || true
        grep -E '^TZ=' .kamal/secrets || echo "TZ=Europe/Helsinki"
        grep -E '^DOMAIN=' .kamal/secrets || true
        grep -E '^CROWDSEC_ENROLL_KEY=' .kamal/secrets || true
        grep -E '^CROWDSEC_BOUNCER_KEY=' .kamal/secrets | sed 's/^CROWDSEC_BOUNCER_KEY=/CROWDSEC_BOUNCER_KEY=/' || true
        grep -E '^GRAFANA_ADMIN_USER=' .kamal/secrets || true
        grep -E '^GRAFANA_ADMIN_PASSWORD=' .kamal/secrets || true
        grep -E '^GOTIFY_ADMIN_USER=' .kamal/secrets || true
        grep -E '^GOTIFY_ADMIN_PASSWORD=' .kamal/secrets || true
        grep -E '^TS_AUTHKEY=' .kamal/secrets | sed 's/^TS_AUTHKEY=/TAILSCALE_AUTH_KEY=/' || true
    } > /tmp/homelab.env
    
    # Upload .env file to server
    if [ -s /tmp/homelab.env ]; then
        rsync -avz /tmp/homelab.env "$SERVER:$HOMELAB_DIR/.env" || {
            echo "âš ï¸  Failed to create .env file, docker-compose may fail"
        }
        rm -f /tmp/homelab.env
    else
        echo "âš ï¸  No environment variables extracted from .kamal/secrets"
    fi
else
    echo "âš ï¸  .kamal/secrets not found, docker-compose may fail without environment variables"
fi

# Run docker-compose on the host
echo "ðŸš€ Starting docker-compose services on host..."
ssh "$SERVER" "cd $HOMELAB_DIR && docker-compose up -d" || {
    echo "âŒ Failed to start docker-compose services"
    exit 1
}

# Wait a moment for services to start
sleep 5

# Health check docker-compose services
if ssh "$SERVER" "cd $HOMELAB_DIR && docker-compose ps | grep -q Up"; then
    echo "âœ… Docker-compose services are running"
else
    echo "âš ï¸  Some docker-compose services may not be running"
    ssh "$SERVER" "cd $HOMELAB_DIR && docker-compose ps"
fi

# Health check Traefik (will be deployed as Kamal accessory)
if ssh "$SERVER" "docker ps | grep -q traefik"; then
    echo "âœ… Traefik is running"
else
    echo "â„¹ï¸  Traefik will be deployed as Kamal accessory"
fi

# Check disk space
DISK_USAGE=$(ssh "$SERVER" "df -h / | awk 'NR==2 {print \$5}' | sed 's/%//'")
if [ "$DISK_USAGE" -gt 90 ]; then
    echo "âŒ Disk usage is > 90%: ${DISK_USAGE}%"
    exit 1
fi

echo "âœ… Pre-deployment checks passed"

