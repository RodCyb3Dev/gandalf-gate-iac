#!/bin/bash
# Kamal post-deployment hook

set -e

echo "✅ Running post-deployment verification..."

# Wait for services
sleep 30

# Verify Traefik
if curl -f -s http://localhost:8080/ping > /dev/null; then
    echo "✅ Traefik is healthy"
else
    echo "❌ Traefik health check failed"
    exit 1
fi

# Verify CrowdSec
if docker exec crowdsec cscli version > /dev/null 2>&1; then
    echo "✅ CrowdSec is healthy"
else
    echo "❌ CrowdSec health check failed"
    exit 1
fi

# Notify success
if [ -n "$GOTIFY_URL" ] && [ -n "$GOTIFY_TOKEN" ]; then
    curl -X POST "$GOTIFY_URL/message?token=$GOTIFY_TOKEN" \
        -F "title=✅ Deployment Successful (Kamal)" \
        -F "message=Homelab deployed successfully via Kamal at $(date)" \
        -F "priority=5"
fi

echo "✅ Post-deployment verification passed"

