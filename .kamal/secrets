#!/usr/bin/env bash

# =============================================================================
# KAMAL SECRETS TEMPLATE
# =============================================================================
# This file is SAFE to commit to git - it uses environment variables and file references
# 
# Setup Instructions:
# 1. Copy this file to .kamal/secrets (if not already present)
# 2. Set environment variables in your shell or use a .env file
# 3. For CI/CD, use GitHub Secrets (they're automatically available as env vars)
#
# Usage: Kamal reads these secrets during deployment
# File location: homelab/.kamal/secrets
#
# Kamal secrets file - outputs environment variables for deployment
# This script is executed by Kamal to inject secrets into containers
# =============================================================================

set -e

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
  echo -e "${GREEN}[Secrets]${NC} $1" >&2
}

warn() {
  echo -e "${YELLOW}[Warning]${NC} $1" >&2
}

error() {
  echo -e "${RED}[Error]${NC} $1" >&2
  exit 1
}

# Check if 1Password CLI is available
if command -v op &> /dev/null; then
  log "Using 1Password CLI for secrets"
  USE_1PASSWORD=true
else
  warn "1Password CLI not found, falling back to .env file"
  USE_1PASSWORD=false
fi

# Function to get secret from 1Password
get_1password_secret() {
    local secret_name=$1
    local vault=${KAMAL_SECRETS_VAULT:-"homelab-env"}

    if [ "$USE_1PASSWORD" = true ]; then
      # Use --reveal to get actual values instead of references
      local value=$(op item get "$secret_name" --vault "$vault" --fields password --reveal 2>/dev/null || echo "")

      # If still empty or reference, try reading from JSON
      if [ -z "$value" ] || [[ "$value" == "[use 'op item get"* ]]; then
        value=$(op item get "$secret_name" --vault "$vault" --format json 2>/dev/null | jq -r '.fields[] | select(.label=="password" or .purpose=="PASSWORD") | .value' 2>/dev/null || echo "")
      fi

      echo "$value"
    else
      echo ""
    fi
}

# Function to get secret from .env file (fallback)
get_env_secret() {
  local secret_name=$1
  local env_file="${KAMAL_SECRETS_ENV_FILE:-.env}"

  if [ -f "$env_file" ]; then
    grep "^${secret_name}=" "$env_file" 2>/dev/null | cut -d '=' -f2- | tr -d '"' || echo ""
  else
    echo ""
  fi
}

# Function to get secret with fallback
get_secret() {
  local secret_name=$1
  local value=""

  # Try 1Password first
  if [ "$USE_1PASSWORD" = true ]; then
    value=$(get_1password_secret "$secret_name")
  fi

  # Fallback to .env file
  if [ -z "$value" ]; then
    value=$(get_env_secret "$secret_name")
  fi

  # Return value or error
  if [ -z "$value" ]; then
    warn "Secret '$secret_name' not found in 1Password or .env"
    echo ""
  else
    echo "$value"
  fi
}

# Export secrets for Kamal
log "Fetching secrets for deployment..."

# Domain Configuration
DOMAIN=$(get_secret "DOMAIN")
CLOUDFLARE_EMAIL=$(get_secret "CF_API_EMAIL")
CLOUDFLARE_API_KEY=$(get_secret "CF_API_KEY")

# Tailscale
TAILSCALE_AUTHKEY=$(get_secret "TS_AUTHKEY")

# Authelia (SSO)
AUTHELIA_JWT_SECRET=$(get_secret "AUTHELIA_JWT_SECRET")
AUTHELIA_SESSION_SECRET=$(get_secret "AUTHELIA_SESSION_SECRET")
AUTHELIA_STORAGE_ENCRYPTION_KEY=$(get_secret "AUTHELIA_STORAGE_ENCRYPTION_KEY")
AUTHELIA_NOTIFIER_SMTP_PASSWORD=$(get_secret "AUTHELIA_NOTIFIER_SMTP_PASSWORD")

# CrowdSec
CROWDSEC_BOUNCER_KEY=$(get_secret "CROWDSEC_BOUNCER_KEY")
CROWDSEC_ENROLL_KEY=$(get_secret "CROWDSEC_ENROLL_KEY")

# Grafana
GRAFANA_ADMIN_USER=$(get_secret "GRAFANA_ADMIN_USER")
GRAFANA_ADMIN_PASSWORD=$(get_secret "GRAFANA_ADMIN_PASSWORD")

# Database Passwords
POSTGRES_PASSWORD=$(get_secret "POSTGRES_PASSWORD")
AUTHELIA_STORAGE_POSTGRES_PASSWORD=$(get_secret "AUTHELIA_STORAGE_POSTGRES_PASSWORD")

# Redis
REDIS_PASSWORD=$(get_secret "REDIS_PASSWORD")

# Storage Box (Hetzner)
STORAGE_BOX_HOST=$(get_secret "STORAGE_BOX_HOST")
STORAGE_BOX_USER=$(get_secret "STORAGE_BOX_USER")
STORAGE_BOX_PASSWORD=$(get_secret "STORAGE_BOX_PASSWORD")

# Backup Encryption
BACKUP_ENCRYPTION_KEY=$(get_secret "BACKUP_ENCRYPTION_KEY")

# Media Server Apps (Optional - if using Arr Stack)
PUID=$(get_secret "PUID" || echo "1000")
PGID=$(get_secret "PGID" || echo "1000")
TIMEZONE=$(get_secret "TIMEZONE" || echo "UTC")

# Docker Registry (for Kamal deployments)
KAMAL_REGISTRY_USERNAME=$(get_secret "KAMAL_REGISTRY_USERNAME")
KAMAL_REGISTRY_PASSWORD=$(get_secret "KAMAL_REGISTRY_PASSWORD")

# Output all secrets in KEY=VALUE format
# Kamal will inject these into the deployment environment
cat <<EOF
DOMAIN=${DOMAIN}
CF_API_EMAIL=${CLOUDFLARE_EMAIL}
CF_API_KEY=${CLOUDFLARE_API_KEY}
TS_AUTHKEY=${TAILSCALE_AUTHKEY}
AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
AUTHELIA_NOTIFIER_SMTP_PASSWORD=${AUTHELIA_NOTIFIER_SMTP_PASSWORD}
CROWDSEC_BOUNCER_KEY=${CROWDSEC_BOUNCER_KEY}
CROWDSEC_ENROLL_KEY=${CROWDSEC_ENROLL_KEY}
GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER}
GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
AUTHELIA_STORAGE_POSTGRES_PASSWORD=${AUTHELIA_STORAGE_POSTGRES_PASSWORD}
REDIS_PASSWORD=${REDIS_PASSWORD}
STORAGE_BOX_HOST=${STORAGE_BOX_HOST}
STORAGE_BOX_USER=${STORAGE_BOX_USER}
STORAGE_BOX_PASSWORD=${STORAGE_BOX_PASSWORD}
BACKUP_ENCRYPTION_KEY=${BACKUP_ENCRYPTION_KEY}
PUID=${PUID}
PGID=${PGID}
TIMEZONE=${TIMEZONE}
KAMAL_REGISTRY_USERNAME=${KAMAL_REGISTRY_USERNAME}
KAMAL_REGISTRY_PASSWORD=${KAMAL_REGISTRY_PASSWORD}
EOF

log "âœ… Secrets loaded successfully"
